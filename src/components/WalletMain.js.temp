// src/components/WalletMain.js - í† í° ì˜êµ¬ ì €ì¥ ê¸°ëŠ¥ ì—°ë™
import React, { useState, useEffect, useCallback } from 'react';
import { 
  Wallet, Send, ArrowDownToLine, History, Settings, 
  LogOut, Trash2, Users, Eye, EyeOff, Copy, RefreshCw,
  Plus, Search, ChevronDown, ChevronUp, Coins, X, CheckCircle, Lock
} from 'lucide-react';
import LanguageToggle from './LanguageToggle';
import { walletService } from '../services/walletService';
import { MultiWalletManager } from '../services/MultiWalletManager';
import { SecureStorage } from '../services/secureStorage'; // SecureStorage ì¶”ê°€
import { NETWORKS } from '../services/networkConfig';
import SendTransaction from './SendTransaction';
import ReceiveWLC from './ReceiveWLC';
import TransactionHistory from './TransactionHistory';
import WalletSettings from './WalletSettings';
import { useTranslation } from '../hooks/useTranslation'; 
import './WalletMain.css';

import Dapp from './Dapp';
import NFTGallery from './NFTGallery'; 

const WalletMain = ({ 
  walletData, 
  onLock, 
  onDelete, 
  onShowWalletList, 
  walletPassword,
  onShowWalletSetup,
  hasWallet 
}) => {
  const { t } = useTranslation();
  const [currentView, setCurrentView] = useState('main');
  const [balance, setBalance] = useState('0.0000');
  const [tokens, setTokens] = useState([]);
  const [selectedAsset, setSelectedAsset] = useState(null); // ì„ íƒëœ ìì‚° (WLC ë˜ëŠ” í† í°)
  const [isLoading, setIsLoading] = useState(false);
  const [showPrivateKey, setShowPrivateKey] = useState(false);
  const [showTokenList, setShowTokenList] = useState(false);
  const [showAddToken, setShowAddToken] = useState(false);
  const [showTokenBrowser, setShowTokenBrowser] = useState(false);
  const [newTokenAddress, setNewTokenAddress] = useState('');
  const [searchToken, setSearchToken] = useState('');
  const [availableTokens, setAvailableTokens] = useState([]);
  const [popularTokens, setPopularTokens] = useState([]);
  const [searchResults, setSearchResults] = useState([]);
  const [isSearching, setIsSearching] = useState(false);
  const [autoRefreshInterval, setAutoRefreshInterval] = useState(null);
  const [lastUpdateTime, setLastUpdateTime] = useState(null);
  const [isAutoRefreshing, setIsAutoRefreshing] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [networkStatus, setNetworkStatus] = useState({ connected: false });
  const [lastTokenListUpdate, setLastTokenListUpdate] = useState(null);
  const [showTokenDetail, setShowTokenDetail] = useState(false); 
  const [selectedTokenDetail, setSelectedTokenDetail] = useState(null);
  const [showAllTokens, setShowAllTokens] = useState(false);

  const [infoUrls, setInfoUrls] = useState([]);
  const [isLoadingUrls, setIsLoadingUrls] = useState(false);
  const [showAllUrls, setShowAllUrls] = useState(false);
  const [bannerAds, setBannerAds] = useState(null);
  const [isLoadingBanner, setIsLoadingBanner] = useState(false);

  const [showDapp, setShowDapp] = useState(false);
  const [selectedDappService, setSelectedDappService] = useState(null);

  const network = walletService.getCurrentNetwork();

  useEffect(() => {
    initializeWallet();
    loadPopularTokens(); 
    startAutoRefresh(); 
    loadInfoUrls(); 
    loadBannerAds();
    
    // ì´ˆê¸° ì„ íƒ ìì‚°ì„ WLCë¡œ ì„¤ì •
    setSelectedAsset({
      type: 'native',
      symbol: 'WLC',
      name: 'WorldLand Coin',
      balance: balance,
      decimals: 18
    });

    // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨ ì •ë¦¬
    return () => {
      stopAutoRefresh();
    };
  }, [walletData, walletPassword]); 

  // ì§€ê°‘ ì´ˆê¸°í™” - ì €ì¥ëœ í† í° ë¡œë“œ ë° ìë™ í† í° ë°œê²¬
  const initializeWallet = async () => {
    // í•„ìˆ˜ ì¡°ê±´ í™•ì¸
    if (!walletData?.id || !walletData?.address || !walletPassword) {
      console.warn(t('WalletMain.walletInitFailed'), {
        hasWalletId: !!walletData?.id,
        hasAddress: !!walletData?.address,
        hasPassword: !!walletPassword
      });
      return;
    }

    console.log(t('WalletMain.tokenAddStarted'), walletData.id);
    
    try {
      // ì €ì¥ëœ í† í° ëª©ë¡ ë¡œë“œ (ë¹„ë°€ë²ˆí˜¸ í•„ìš”)
      const savedTokens = MultiWalletManager.getWalletTokens(walletData.id, walletPassword);
      if (savedTokens.length > 0) {
        setTokens(savedTokens);
        console.log(`ì €ì¥ëœ í† í° ${savedTokens.length}ê°œ ë¡œë“œë¨`);
      }

      // í†µí•© ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰ (í† í° ë°œê²¬ + í† í° ëª©ë¡ ê°±ì‹ )
      await refreshAllData(false);
    } catch (error) {
      console.error('ì§€ê°‘ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      setError(t('WalletMain.walletInitFailed'));
    }
  };

  // ë³´ì•ˆ ê°•í™”: ì…ë ¥ê°’ ì •ë¦¬ í•¨ìˆ˜
  const sanitizeInput = useCallback((input) => {
    if (typeof input !== 'string') return input;
    
    return input
      .replace(/[<>\"']/g, '') // HTML íƒœê·¸ ì œê±°
      .replace(/javascript:/gi, '') // JavaScript í”„ë¡œí† ì½œ ì œê±°
      .replace(/on\w+=/gi, '') // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì œê±°
      .replace(/data:/gi, '') // Data URI ì œê±°
      .trim()
      .slice(0, 200); // ìµœëŒ€ ê¸¸ì´ ì œí•œ
  }, []);

  // ë³´ì•ˆ ê°•í™”: ë¯¼ê°í•œ ë°ì´í„° ì •ë¦¬
  const clearSensitiveData = useCallback(() => {
    if (walletPassword) {
      SecureStorage.clearSensitiveData({ password: walletPassword });
    }
  }, [walletPassword]);

  // ë¹„í™œì„± ìƒíƒœ ê°ì§€ ë° ìë™ ì ê¸ˆ
  useEffect(() => {
    let inactivityTimer;
    
    const resetTimer = () => {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        // 5ë¶„ ë¹„í™œì„± ì‹œ ìë™ ì ê¸ˆ
        clearSensitiveData();
        onLock();
      }, 3600000);
    };

    const events = [
      'mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart',
      'click', 'focus', 'input', 'change', 'wheel', 'touchmove' // ì¶”ê°€
    ];

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì‹œ ì˜µì…˜ ê°œì„ 
    events.forEach(event => {
      document.addEventListener(event, resetTimer, { 
        passive: true,
        capture: true // ìº¡ì²˜ë§ë„ í™œì„±í™”
      });
    });

    resetTimer();

    return () => {
      clearTimeout(inactivityTimer);
      events.forEach(event => {
        document.removeEventListener(event, resetTimer);
      });
    };
  }, [onLock, clearSensitiveData]);

  const handleBannerClick = () => {
    if (bannerAds?.url) {
      window.open(bannerAds.url, '_blank', 'noopener,noreferrer');
    }
  };

  const loadBannerAds = async () => {
    setIsLoadingBanner(true);
    try {
      const response = await fetch(`${process.env.PUBLIC_URL}/bannerAds.json`, {
        cache: 'no-cache', // PWA ìºì‹œ ë¬¸ì œ í•´ê²°
        headers: {
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      });
      
      if (response.ok) {
        const bannerData = await response.json();
        bannerData.url = '/sites.html';  // bannerData.urlì„ ì†ŒìŠ¤ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ì—¬ ìˆ˜ì •í•˜ì§€ ëª»í•˜ê²Œ í•¨.
        
        // URLë“¤ì„ PUBLIC_URLì„ ê³ ë ¤í•˜ì—¬ ì²˜ë¦¬
        const processedBannerData = {
          ...bannerData,
          // ì´ë¯¸ì§€ ê²½ë¡œê°€ ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° PUBLIC_URL ì¶”ê°€
          imageSrc: bannerData.imageSrc && !bannerData.imageSrc.startsWith('http') && !bannerData.imageSrc.startsWith('//')
            ? `${process.env.PUBLIC_URL}${bannerData.imageSrc}`
            : bannerData.imageSrc,
          // ë§í¬ URLì´ ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° PUBLIC_URL ì¶”ê°€
          url: bannerData.url && !bannerData.url.startsWith('http') && !bannerData.url.startsWith('//')
            ? `${process.env.PUBLIC_URL}${bannerData.url}`
            : bannerData.url
        };
        
        setBannerAds(processedBannerData);
        console.log(t('WalletMain.bannerAdsLoaded'), processedBannerData);
      } else {
        console.warn('ë°°ë„ˆ ê´‘ê³  íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', response.status);
      }
    } catch (error) {
      console.error('ë°°ë„ˆ ê´‘ê³  ë¡œë“œ ì‹¤íŒ¨:', error);
    } finally {
      setIsLoadingBanner(false);
    }
  };

  const loadInfoUrls = async () => {
    setIsLoadingUrls(true);
    try {
      const response = await fetch(`${process.env.PUBLIC_URL}/infoUrlList.json`, {
        cache: 'no-cache', // PWA ìºì‹œ ë¬¸ì œ í•´ê²°
        headers: {
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      });
      
      if (response.ok) {
        const urls = await response.json();
        
        // URLë“¤ì„ PUBLIC_URLì„ ê³ ë ¤í•˜ì—¬ ì²˜ë¦¬
        const processedUrls = urls.map(item => ({
          ...item,
          // ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° PUBLIC_URL ì¶”ê°€
          url: item.url && !item.url.startsWith('http') && !item.url.startsWith('//')
            ? `${process.env.PUBLIC_URL}${item.url}`
            : item.url
        }));
        
        setInfoUrls(processedUrls);
        console.log(t('WalletMain.boardUrlsLoaded'), processedUrls.length);
      } else {
        console.warn('ê²Œì‹œíŒ URL íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', response.status);
      }
    } catch (error) {
      console.error('ê²Œì‹œíŒ URL ë¡œë“œ ì‹¤íŒ¨:', error);
    } finally {
      setIsLoadingUrls(false);
    }
  };

  // ìë™ í† í° ë°œê²¬ ê¸°ëŠ¥
  const discoverAndLoadTokens = async () => {
    if (!walletData?.address || !walletData?.id || !walletPassword) {
      console.warn(t('WalletMain.noTokensFound'));
      return;
    }

    try {
      console.log(t('WalletMain.tokenInfoQuerying'), walletData.address);
      setIsLoading(true);

      // WorldLand Explorer APIë¥¼ í†µí•´ ì´ ì§€ê°‘ì˜ ëª¨ë“  í† í° ì”ì•¡ ì¡°íšŒ
      const result = await walletService.getAllBalances(walletData.address);
      
      if (result.success) {
        // ë„¤ì´í‹°ë¸Œ í† í° (WLC) ì”ì•¡ ì„¤ì •
        if (result.native) {
          setBalance(result.native.balance);
          console.log('WLC ì”ì•¡:', result.native.balance);
        }

        // ë°œê²¬ëœ í† í°ë“¤ ì²˜ë¦¬
        if (result.tokens && result.tokens.length > 0) {
          const existingTokens = MultiWalletManager.getWalletTokens(walletData.id, walletPassword);
          const existingAddresses = new Set(
            existingTokens.map(t => t.address.toLowerCase())
          );

          let newTokensAdded = 0;
          let updatedTokensCount = 0;

          // ê° í† í°ì— ëŒ€í•´ ì²˜ë¦¬
          for (const discoveredToken of result.tokens) {
            const tokenAddress = discoveredToken.address.toLowerCase();
            
            if (existingAddresses.has(tokenAddress)) {
              // ê¸°ì¡´ í† í°ì˜ ì”ì•¡ ì—…ë°ì´íŠ¸
              const updateResult = MultiWalletManager.updateTokenBalance(
                walletData.id,
                discoveredToken.address,
                discoveredToken.balance,
                discoveredToken.balanceRaw,
                walletPassword // ë¹„ë°€ë²ˆí˜¸ ì¶”ê°€
              );
              
              if (updateResult.success) {
                updatedTokensCount++;
              }
            } else {
              // ìƒˆë¡œìš´ í† í° ì¶”ê°€ (ì”ì•¡ì´ 0ë³´ë‹¤ í° ê²½ìš°ë§Œ)
              const balance = parseFloat(discoveredToken.balance || '0');
              
              if (balance > 0) {
                const addResult = MultiWalletManager.addTokenToWallet(
                  walletData.id, 
                  discoveredToken,
                  walletPassword // ë¹„ë°€ë²ˆí˜¸ ì¶”ê°€
                );
                
                if (addResult.success) {
                  newTokensAdded++;
                  console.log(`ìƒˆ í† í° ìë™ ì¶”ê°€: ${discoveredToken.symbol} (ì”ì•¡: ${discoveredToken.balance})`);
                }
              }
            }
          }

          // ìƒíƒœ ì—…ë°ì´íŠ¸
          const finalTokens = MultiWalletManager.getWalletTokens(walletData.id, walletPassword);
          setTokens(finalTokens);

          // ì‚¬ìš©ìì—ê²Œ ê²°ê³¼ ì•Œë¦¼
          if (newTokensAdded > 0 || updatedTokensCount > 0) {
            let message = '';
            if (newTokensAdded > 0) {
              message += `${newTokensAdded}${t('WalletMain.newTokensFound')}`;
            }
            setSuccess(message);
            
            // 3ì´ˆ í›„ ë©”ì‹œì§€ ìë™ ì œê±°
            setTimeout(() => setSuccess(''), 3000);
          }

          console.log(`í† í° ë°œê²¬ ì™„ë£Œ: ì‹ ê·œ ${newTokensAdded}ê°œ, ì—…ë°ì´íŠ¸ ${updatedTokensCount}ê°œ`);
        } else {
          console.log(t('WalletMain.noTokensFound'));
        }
      } else {
        console.warn('í†µí•© ì”ì•¡ ì¡°íšŒ ì‹¤íŒ¨, ê°œë³„ ì¡°íšŒë¡œ ëŒ€ì²´');
        
        // API ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ë„¤ì´í‹°ë¸Œ ì”ì•¡ë§Œ ì¡°íšŒ
        const nativeResult = await walletService.getBalance(walletData.address);
        if (nativeResult.success) {
          setBalance(nativeResult.balance);
        }

        // ê¸°ì¡´ ì €ì¥ëœ í† í°ë“¤ì˜ ì”ì•¡ë§Œ ì—…ë°ì´íŠ¸
        const savedTokens = MultiWalletManager.getWalletTokens(walletData.id, walletPassword);
        if (savedTokens.length > 0) {
          const tokenUpdateResult = await MultiWalletManager.updateAllTokenBalances(
            walletData.id, 
            walletData.address,
            walletPassword // ë¹„ë°€ë²ˆí˜¸ ì¶”ê°€
          );
          
          if (tokenUpdateResult.success) {
            setTokens(tokenUpdateResult.tokens);
            console.log(`${t('WalletMain.tokenBalanceUpdated')} ${tokenUpdateResult.updatedCount}ê°œ`);
          }
        }
      }
    } catch (error) {
      console.error('ìë™ í† í° ë°œê²¬ ì‹¤íŒ¨:', error);
      
      // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ê¸°ë³¸ ì”ì•¡ì€ ì¡°íšŒ ì‹œë„
      try {
        const nativeResult = await walletService.getBalance(walletData.address);
        if (nativeResult.success) {
          setBalance(nativeResult.balance);
        }
      } catch (balanceError) {
        console.error('ë„¤ì´í‹°ë¸Œ ì”ì•¡ ì¡°íšŒë„ ì‹¤íŒ¨:', balanceError);
      }
    } finally {
      setIsLoading(false);
    }
  };

  // í†µí•© ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ (í† í° ë°œê²¬ + í† í° ëª©ë¡ ê°±ì‹ )
  const refreshAllData = async (isAutoRefresh = false) => {
    try {
      console.log(t('WalletMain.dataRefreshComplete'));
      
      // 1. í† í° ë°œê²¬ ë° ì”ì•¡ ì—…ë°ì´íŠ¸
      await discoverAndLoadTokens();
      
      // 2. í† í° ëª©ë¡ ê°±ì‹  (ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ì´ê±°ë‚˜ 5ë¶„ë§ˆë‹¤)
      const shouldUpdateTokenList = !isAutoRefresh || 
        !lastTokenListUpdate || 
        (Date.now() - lastTokenListUpdate) > 5 * 60 * 1000; // 5ë¶„
      
      if (shouldUpdateTokenList) {
        console.log(t('WalletMain.popularTokensLoading'));
        await loadPopularTokens();
        setLastTokenListUpdate(Date.now());
      }
      
      setLastUpdateTime(new Date());
      console.log(t('WalletMain.dataRefreshComplete'));
    } catch (error) {
      console.error('í†µí•© ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
      throw error;
    }
  };

  // ìˆ˜ë™ í† í° ë°œê²¬ (ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­ ì‹œ)
  const handleManualTokenDiscovery = async () => {
    if (!walletData?.address || !walletData?.id) return;

    setIsLoading(true);
    try {
      setSuccess(t('WalletMain.searchingTokens'));
      await refreshAllData(false); // í† í° ëª©ë¡ë„ í•¨ê»˜ ê°±ì‹ 
      // ìë™ ìƒˆë¡œê³ ì¹¨ ì¬ì‹œì‘
      startAutoRefresh();
    } catch (error) {
      setError(t('WalletMain.tokenSearchFailed'));
    } finally {
      setIsLoading(false);
    }
  };

  // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
  const startAutoRefresh = () => {
    // ê¸°ì¡´ ì¸í„°ë²Œì´ ìˆë‹¤ë©´ ì •ë¦¬
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }

    // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ (í† í° ë°œê²¬ + í† í° ëª©ë¡ ê°±ì‹  í¬í•¨)
    const interval = setInterval(() => {
      console.log(t('WalletMain.autoBalanceUpdate'));
      setIsAutoRefreshing(true);
      refreshAllData(true).finally(() => { // ìë™ ìƒˆë¡œê³ ì¹¨ì€ í† í° ëª©ë¡ì„ 5ë¶„ë§ˆë‹¤ë§Œ ê°±ì‹ 
        setIsAutoRefreshing(false);
      });
    }, 300000); // 5ë¶„

    setAutoRefreshInterval(interval);
    setLastUpdateTime(new Date());
    console.log(t('WalletMain.autoRefreshStarted'));
  };

  // ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
  const stopAutoRefresh = () => {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      setAutoRefreshInterval(null);
      console.log(t('WalletMain.autoRefreshStopped'));
    }
  };

  // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ (ìë™ ìƒˆë¡œê³ ì¹¨ ì¬ì‹œì‘ + í† í° ë°œê²¬ + í† í° ëª©ë¡ ê°±ì‹ )
  const handleManualRefresh = async () => {
    setIsLoading(true);
    try {
      // í†µí•© ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰ (í† í° ëª©ë¡ë„ ê°±ì‹ )
      await refreshAllData(false);
      
      // ìë™ ìƒˆë¡œê³ ì¹¨ ì¬ì‹œì‘
      startAutoRefresh();
      
      // ì„±ê³µ ë©”ì‹œì§€ëŠ” discoverAndLoadTokensì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨
      if (!success) {
        setSuccess(t('WalletMain.allDataUpdated'));
        setTimeout(() => setSuccess(''), 1000);
      }
    } catch (error) {
      setError(t('WalletMain.dataUpdateFailed'));
      setTimeout(() => setSuccess(''), 1000);
    } finally {
      setIsLoading(false);
    }
  };

  // ì¸ê¸° í† í° ëª©ë¡ ë¡œë“œ
  const loadPopularTokens = async () => {
    try {
      console.log(t('WalletMain.popularTokensLoading'));
      const result = await walletService.getPopularTokens(20);
      if (result.success) {
        setPopularTokens(result.tokens);
        console.log(`ì¸ê¸° í† í° ${result.tokens.length}ê°œ ë¡œë“œë¨`);
      } else {
        console.warn('ì¸ê¸° í† í° ë¡œë“œ ì‹¤íŒ¨:', result.error);
      }
    } catch (error) {
      console.warn('ì¸ê¸° í† í° ë¡œë“œ ì˜ˆì™¸:', error);
    }
  };

  // í† í° ê²€ìƒ‰
  const handleTokenSearch = async (query) => {
    if (!query || query.trim().length < 2) {
      setSearchResults([]);
      return;
    }

    setIsSearching(true);
    try {
      const result = await walletService.searchTokens(query);
      if (result.success) {
        setSearchResults(result.tokens);
      } else {
        setSearchResults([]);
        setError(result.error);
      }
    } catch (error) {
      setSearchResults([]);
      setError(t('WalletMain.tokenSearchFailed'));
    } finally {
      setIsSearching(false);
    }
  };

  useEffect(() => {
    // ì”ì•¡ì´ ì—…ë°ì´íŠ¸ë˜ë©´ ì„ íƒëœ ìì‚°ë„ ì—…ë°ì´íŠ¸
    if (selectedAsset && selectedAsset.type === 'native') {
      setSelectedAsset(prev => ({ ...prev, balance }));
    }
  }, [balance]);

  // í† í° ìƒì„¸ ì •ë³´ ë³´ê¸°
  const handleViewTokenDetail = (token) => {
    setSelectedTokenDetail(token);
    setShowTokenDetail(true);
  };

  // í† í° ìƒì„¸ ì°½ ë‹«ê¸°
  const handleCloseTokenDetail = () => {
    setShowTokenDetail(false);
    setSelectedTokenDetail(null);
  };

  // loadAllBalances í•¨ìˆ˜ ìˆ˜ì • - ë¹„ë°€ë²ˆí˜¸ ë§¤ê°œë³€ìˆ˜ ì¶”ê°€
  const loadAllBalances = async () => {
    if (!walletData?.address || !walletData?.id || !walletPassword) {
      console.warn(t('WalletMain.balanceUpdateFailed'));
      return;
    }
    
    // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë¡œë”© ìƒíƒœ ì„¤ì •
    if (!isAutoRefreshing) {
      setIsLoading(true);
    }
    
    try {
      console.log(t('WalletMain.balanceQueryStarted'), walletData.address);
      
      // í†µí•© ì”ì•¡ ì¡°íšŒ (ë„¤ì´í‹°ë¸Œ + í† í°ë“¤)
      const result = await walletService.getAllBalances(walletData.address);
      
      if (result.success) {
        // ë„¤ì´í‹°ë¸Œ í† í° (WLC) ì”ì•¡ ì„¤ì •
        if (result.native) {
          setBalance(result.native.balance);
          console.log('WLC ì”ì•¡:', result.native.balance);
        }
        
        // ì €ì¥ëœ í† í°ë“¤ì˜ ì”ì•¡ ì—…ë°ì´íŠ¸
        const savedTokens = MultiWalletManager.getWalletTokens(walletData.id, walletPassword);
        
        if (savedTokens.length > 0) {
          // ì €ì¥ëœ í† í°ë“¤ì˜ ì”ì•¡ì„ APIì—ì„œ ì¡°íšŒëœ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
          const updatedTokens = savedTokens.map(savedToken => {
            const foundToken = result.tokens?.find(apiToken => 
              apiToken.address.toLowerCase() === savedToken.address.toLowerCase()
            );
            
            if (foundToken) {
              // APIì—ì„œ ì°¾ì€ ì”ì•¡ìœ¼ë¡œ ì—…ë°ì´íŠ¸
              const updatedToken = {
                ...savedToken,
                balance: foundToken.balance,
                balanceRaw: foundToken.balanceRaw,
                lastUpdated: Date.now()
              };
              
              // MultiWalletManagerì—ë„ ì—…ë°ì´íŠ¸ëœ ì”ì•¡ ì €ì¥ (ë¹„ë°€ë²ˆí˜¸ í¬í•¨)
              MultiWalletManager.updateTokenBalance(
                walletData.id, 
                foundToken.address, 
                foundToken.balance, 
                foundToken.balanceRaw,
                walletPassword
              );
              
              return updatedToken;
            }
            
            return savedToken; // APIì—ì„œ ì°¾ì§€ ëª»í•œ ê²½ìš° ê¸°ì¡´ ì •ë³´ ìœ ì§€
          });
          
          setTokens(updatedTokens);
          console.log(`ì €ì¥ëœ í† í° ${updatedTokens.length}ê°œ ì”ì•¡ ì—…ë°ì´íŠ¸ë¨`);
        }
        
        // APIì—ì„œ ìƒˆë¡œ ë°œê²¬ëœ í† í°ë“¤ ì¤‘ ì”ì•¡ì´ 0ë³´ë‹¤ í° ê²ƒë“¤ ìë™ ì¶”ê°€
        if (result.tokens && result.tokens.length > 0) {
          const existingAddresses = new Set(
            MultiWalletManager.getWalletTokens(walletData.id, walletPassword).map(t => t.address.toLowerCase())
          );
          
          const newTokens = result.tokens.filter(token => 
            !existingAddresses.has(token.address.toLowerCase()) && 
            parseFloat(token.balance) > 0 // ì”ì•¡ì´ 0ë³´ë‹¤ í° í† í°ë§Œ
          );
          
          // ìƒˆë¡œ ë°œê²¬ëœ í† í°ë“¤ì„ ìë™ìœ¼ë¡œ ì¶”ê°€
          for (const newToken of newTokens) {
            const addResult = MultiWalletManager.addTokenToWallet(
              walletData.id, 
              newToken, 
              walletPassword
            );
            if (addResult.success) {
              console.log(`ìƒˆ í† í° ìë™ ì¶”ê°€: ${newToken.symbol}`);
            }
          }
          
          // ìƒˆë¡œ ì¶”ê°€ëœ í† í°ì´ ìˆìœ¼ë©´ ìƒíƒœ ì—…ë°ì´íŠ¸
          if (newTokens.length > 0) {
            const allTokens = MultiWalletManager.getWalletTokens(walletData.id, walletPassword);
            setTokens(allTokens);
          }
        }
        
        // ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ì„±ê³µ ë©”ì‹œì§€
        if (!isAutoRefreshing) {
          console.log('ì”ì•¡ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }
      } else {
        // ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ë„¤ì´í‹°ë¸Œ ì”ì•¡ë§Œ ì¡°íšŒ
        const nativeResult = await walletService.getBalance(walletData.address);
        if (nativeResult.success) {
          setBalance(nativeResult.balance);
        }
        
        // ì €ì¥ëœ í† í°ë“¤ì˜ ì”ì•¡ì„ ê°œë³„ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        const savedTokens = MultiWalletManager.getWalletTokens(walletData.id, walletPassword);
        if (savedTokens.length > 0) {
          const tokenUpdateResult = await MultiWalletManager.updateAllTokenBalances(
            walletData.id, 
            walletData.address,
            walletPassword
          );
          
          if (tokenUpdateResult.success) {
            setTokens(tokenUpdateResult.tokens);
            console.log(`ê°œë³„ í† í° ì”ì•¡ ì—…ë°ì´íŠ¸: ${tokenUpdateResult.updatedCount}ê°œ`);
          }
        }
        
        if (!isAutoRefreshing) {
          console.warn('í†µí•© ì¡°íšŒ ì‹¤íŒ¨, ê°œë³„ ì¡°íšŒë¡œ ëŒ€ì²´');
        }
      }
    } catch (error) {
      console.error('ì”ì•¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
      if (!isAutoRefreshing) {
        setError(t('WalletMain.balanceUpdateFailed'));
        setTimeout(() => setError(''), 3000);
      }
    } finally {
      if (!isAutoRefreshing) {
        setIsLoading(false);
      }
    }
  };

  // ë³´ì•ˆ ê°•í™”ëœ handleAddToken í•¨ìˆ˜ - ì™„ì „í•œ ìˆ˜ì •ë³¸
  const handleAddToken = async (token) => {
    // 1. ê¸°ë³¸ ê²€ì¦ - ì§€ê°‘ ì •ë³´ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    if (!walletData?.id) {
      setError(t('WalletMain.authRequired'));
      console.error('ì§€ê°‘ ë°ì´í„° ëˆ„ë½:', walletData);
      return;
    }

    if (!walletPassword) {
      setError(t('WalletMain.authRequired'));
      console.error('ì§€ê°‘ ë¹„ë°€ë²ˆí˜¸ ëˆ„ë½');
      return;
    }

    console.log(t('WalletMain.tokenAddStarted'), { walletId: walletData.id, token });

    if (!token) {
      // === ìˆ˜ë™ í† í° ì¶”ê°€ (ì£¼ì†Œ ì…ë ¥) ===
      
      // 2. ì…ë ¥ê°’ ë³´ì•ˆ ê²€ì‚¬ ë° ì •ë¦¬
      const sanitizedAddress = sanitizeInput(newTokenAddress.trim());
      
      if (!sanitizedAddress) {
        setError(t('WalletMain.enterTokenAddress'));
        return;
      }

      // 3. ì£¼ì†Œ í˜•ì‹ ê²€ì¦
      if (!walletService.isValidAddress(sanitizedAddress)) {
        setError(t('WalletMain.invalidAddress'));
        return;
      }

      // 4. ì£¼ì†Œ ì •ê·œí™” (ì†Œë¬¸ì ë³€í™˜)
      const normalizedAddress = sanitizedAddress.toLowerCase();

      setIsLoading(true);
      try {
        console.log(t('WalletMain.tokenInfoQuerying'), normalizedAddress);
        
        // 5. í† í° ì •ë³´ ì¡°íšŒ
        const result = await walletService.getTokenBalance(walletData.address, normalizedAddress);
        
        if (result.success) {
          console.log('í† í° ì •ë³´ ì¡°íšŒ ì„±ê³µ:', result.token);
          
          // 6. MultiWalletManagerì— í† í° ì¶”ê°€ (ì•”í˜¸í™” ì €ì¥)
          const addResult = MultiWalletManager.addTokenToWallet(
            walletData.id, 
            result.token, 
            walletPassword
          );
          
          console.log('í† í° ì¶”ê°€ ê²°ê³¼:', addResult);
          
          if (addResult.success) {
            // 7. ìƒíƒœ ì—…ë°ì´íŠ¸ - ì•”í˜¸í™”ëœ ì €ì¥ì†Œì—ì„œ í† í° ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
            const updatedTokens = MultiWalletManager.getWalletTokens(walletData.id, walletPassword);
            console.log('ì—…ë°ì´íŠ¸ëœ í† í° ëª©ë¡:', updatedTokens);
            
            setTokens(updatedTokens);
            setSuccess(`${result.token.symbol} ${t('WalletMain.tokenAdded')}`);
            setTimeout(() => setSuccess(''), 2000);
            
            // 8. ì…ë ¥ í•„ë“œ ì •ë¦¬ ë° ëª¨ë‹¬ ë‹«ê¸°
            setNewTokenAddress('');
            setShowAddToken(false);
          } else {
            console.error('í† í° ì¶”ê°€ ì‹¤íŒ¨:', addResult);
            setError(addResult.error || t('WalletMain.tokenAddFailed'));
          }
        } else {
          console.error('í† í° ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', result);
          setError(result.error || t('WalletMain.tokenInfoFailed'));
        }
      } catch (error) {
        console.error('í† í° ì¶”ê°€ ì˜ˆì™¸:', error);
        setError(t('WalletMain.tokenAddFailed') + ': ' + error.message);
      } finally {
        setIsLoading(false);
      }
    } else {
      // === ë¸Œë¼ìš°ì €ì—ì„œ ì„ íƒëœ í† í° ì¶”ê°€ ===
      
      setIsLoading(true);
      try {
        console.log('ë¸Œë¼ìš°ì € í† í° ì¶”ê°€ ì‹œì‘:', token);
        
        // 9. í† í° ë°ì´í„° ë³´ì•ˆ ê²€ì¦
        if (!token.address || !token.symbol) {
          throw new Error(t('WalletMain.incompleteTokenInfo'));
        }

        // 10. ì£¼ì†Œ í˜•ì‹ ê²€ì¦
        if (!walletService.isValidAddress(token.address)) {
          throw new Error(t('WalletMain.invalidTokenAddress'));
        }

        // 11. í† í° ë°ì´í„° ì •ë¦¬ ë° ì •ê·œí™”
        const sanitizedToken = {
          address: token.address.toLowerCase(),
          name: sanitizeInput(token.name || 'Unknown Token'),
          symbol: sanitizeInput(token.symbol || 'UNK'),
          decimals: parseInt(token.decimals) || 18,
          type: token.type || 'ERC-20',
          verified: Boolean(token.verified),
          description: token.description ? sanitizeInput(token.description) : '',
          homepage: token.homepage ? sanitizeInput(token.homepage) : null,
          balance: '0',
          balanceRaw: '0'
        };
        
        // 12. MultiWalletManagerì— í† í° ì¶”ê°€ (ì•”í˜¸í™” ì €ì¥)
        const addResult = MultiWalletManager.addTokenToWallet(
          walletData.id, 
          sanitizedToken, 
          walletPassword
        );
        
        console.log('ë¸Œë¼ìš°ì € í† í° ì¶”ê°€ ê²°ê³¼:', addResult);
        
        if (addResult.success) {
          // 13. í† í° ì”ì•¡ ì¡°íšŒ ì‹œë„ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ)
          try {
            console.log(t('WalletMain.balanceQueryStarted'), sanitizedToken.address);
            const balanceResult = await walletService.getTokenBalance(walletData.address, sanitizedToken.address);
            
            if (balanceResult.success) {
              console.log('í† í° ì”ì•¡ ì¡°íšŒ ì„±ê³µ:', balanceResult.token);
              // 14. ì”ì•¡ ì •ë³´ë¡œ í† í° ì—…ë°ì´íŠ¸ (ì•”í˜¸í™” ì €ì¥)
              const updateResult = MultiWalletManager.updateTokenBalance(
                walletData.id,
                sanitizedToken.address,
                balanceResult.token.balance,
                balanceResult.token.balanceRaw,
                walletPassword
              );
              
              if (!updateResult.success) {
                console.warn('í† í° ì”ì•¡ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateResult.error);
              }
            } else {
              console.warn('í† í° ì”ì•¡ ì¡°íšŒ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', balanceResult);
            }
          } catch (balanceError) {
            console.warn('í† í° ì”ì•¡ ì¡°íšŒ ì˜ˆì™¸, ê¸°ë³¸ê°’ ì‚¬ìš©:', balanceError);
          }
          
          // 15. ìƒíƒœ ì—…ë°ì´íŠ¸ - ì•”í˜¸í™”ëœ ì €ì¥ì†Œì—ì„œ ìµœì‹  í† í° ëª©ë¡ ë¡œë“œ
          const updatedTokens = MultiWalletManager.getWalletTokens(walletData.id, walletPassword);
          console.log('ìµœì¢… ì—…ë°ì´íŠ¸ëœ í† í° ëª©ë¡:', updatedTokens);
          
          setTokens(updatedTokens);
          setSuccess(`${sanitizedToken.symbol} ${t('WalletMain.tokenAdded')}`);
          setTimeout(() => setSuccess(''), 2000);
          setShowTokenBrowser(false);
        } else {
          console.error('ë¸Œë¼ìš°ì € í† í° ì¶”ê°€ ì‹¤íŒ¨:', addResult);
          setError(addResult.error || t('WalletMain.tokenAddFailed'));
        }
      } catch (error) {
        console.error('ë¸Œë¼ìš°ì € í† í° ì¶”ê°€ ì˜ˆì™¸:', error);
        setError(t('WalletMain.tokenAddFailed') + ': ' + error.message);
      } finally {
        setIsLoading(false);
      }
    }

    // 16. ì—ëŸ¬ ë©”ì‹œì§€ ìë™ ì œê±°
    if (error) {
      setTimeout(() => setError(''), 5000);
    }
  };

  const handleRemoveToken = (tokenAddress) => {
    if (!walletData?.id || !walletPassword) {
      console.error('í† í° ì œê±° ì‹¤íŒ¨: ì§€ê°‘ ì •ë³´ë‚˜ ë¹„ë°€ë²ˆí˜¸ ëˆ„ë½');
      setError(t('WalletMain.authRequiredForRemoval'));
      return;
    }

    if (window.confirm(t('WalletMain.confirmRemoveToken'))) {
      try {
        // ë¹„ë°€ë²ˆí˜¸ë¥¼ í¬í•¨í•˜ì—¬ í† í° ì œê±°
        const removeResult = MultiWalletManager.removeTokenFromWallet(
          walletData.id, 
          tokenAddress, 
          walletPassword
        );
        
        if (removeResult.success) {
          // ìƒíƒœ ì—…ë°ì´íŠ¸ - ì•”í˜¸í™”ëœ ì €ì¥ì†Œì—ì„œ í† í° ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
          const updatedTokens = MultiWalletManager.getWalletTokens(walletData.id, walletPassword);
          setTokens(updatedTokens);
          setSuccess(t('WalletMain.tokenRemoved'));
          
          // ì œê±°ëœ í† í°ì´ í˜„ì¬ ì„ íƒëœ ìì‚°ì´ë©´ WLCë¡œ ë³€ê²½
          if (selectedAsset && selectedAsset.address === tokenAddress) {
            setSelectedAsset({
              type: 'native',
              symbol: 'WLC',
              name: 'WorldLand Coin',
              balance: balance,
              decimals: 18
            });
          }
          
          // ì„±ê³µ ë©”ì‹œì§€ ìë™ ì œê±°
          setTimeout(() => setSuccess(''), 2000);
        } else {
          console.error('í† í° ì œê±° ì‹¤íŒ¨:', removeResult.error);
          setError(removeResult.error || t('WalletMain.tokenRemoveFailed'));
          setTimeout(() => setError(''), 3000);
        }
      } catch (error) {
        console.error('í† í° ì œê±° ì˜ˆì™¸:', error);
        setError(t('WalletMain.tokenRemoveFailed'));
        setTimeout(() => setError(''), 3000);
      }
    }
  };

  const handleAssetSelect = (asset) => {
    setSelectedAsset(asset);
    setShowTokenList(false);
  };

  const copyToClipboard = async (text, type = t('WalletMain.tokenAddressCopied')) => {
    try {
      await navigator.clipboard.writeText(text);
      setSuccess(`${type}${t('WalletMain.addressCopied')}`);
      
      // 0.5ì´ˆ í›„ ìë™ìœ¼ë¡œ ë©”ì‹œì§€ ì œê±°
      setTimeout(() => setSuccess(''), 500);
    } catch (error) {
      setError(t('WalletMain.copyFailed'));
      setTimeout(() => setError(''), 3000);
    }
  };

  const formatAddress = (address) => {
    return `${address.slice(0, 6)}...${address.slice(-4)}`;
  };

  const formatBalance = (balance) => {
    const num = parseFloat(balance || 0);
    if (num === 0) return '0.0000';
    if (num < 0.0001) return '<0.0001';
    return num.toFixed(4);
  };

  const filteredTokens = tokens.filter(token =>
    token.symbol.toLowerCase().includes(searchToken.toLowerCase()) ||
    token.name.toLowerCase().includes(searchToken.toLowerCase())
  );

  const allAssets = [
    {
      type: 'native',
      symbol: 'WLC',
      name: 'WorldLand Coin',
      balance: balance,
      decimals: 18
    },
    ...tokens
  ];

  const filteredAssets = allAssets.filter(asset =>
    asset.symbol.toLowerCase().includes(searchToken.toLowerCase()) ||
    asset.name.toLowerCase().includes(searchToken.toLowerCase())
  );

  // ì „ì†¡ ì„±ê³µ ì½œë°±
  const handleTransactionSuccess = (result) => {
    // ë¯¼ê°í•œ ë°ì´í„° ì •ë¦¬
    clearSensitiveData();
    
    setSuccess(`${t('WalletMain.sendTransactionCompleted')}${result.hash.slice(0, 10)}...`);
    setCurrentView('main');
    setTimeout(() => {
      handleManualRefresh();
    }, 2000);
  };

  // DApp ì„œë¹„ìŠ¤ ì„ íƒ
  const handleDappServiceSelect = (serviceId) => {
    setSelectedDappService(serviceId);
  };

  // DAppì—ì„œ ë’¤ë¡œê°€ê¸°
  const handleBackFromDapp = () => {
    setSelectedDappService(null);
    setShowDapp(false);
  };

  // DApp ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
  const handleDappButtonClick = () => {
    console.log('ğŸ” DApp ë²„íŠ¼ í´ë¦­ - walletData:', walletData);
    console.log('ğŸ” isDummy:', walletData?.isDummy);
    console.log('ğŸ” address:', walletData?.address);
    
    // ë”ë¯¸ ì§€ê°‘ì´ê±°ë‚˜ ì£¼ì†Œê°€ ì—†ëŠ” ê²½ìš°
    if (walletData?.isDummy || !walletData?.address || walletData.address === '0x0000000000000000000000000000000000000000') {
      alert('ì§€ê°‘ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.\n\n"ì§€ê°‘ ì„¤ì •í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì§€ê°‘ì„ ìƒì„±í•˜ê±°ë‚˜ ê°€ì ¸ì˜¤ì„¸ìš”.');
      return;
    }
    
    // ì •ìƒ ì§€ê°‘ì¸ ê²½ìš° DApp í™”ë©´ í‘œì‹œ
    setShowDapp(true);
  };

  // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
  const formatLastUpdateTime = () => {
    if (!lastUpdateTime) return '';
    
    const now = new Date();
    const diff = Math.floor((now - lastUpdateTime) / 1000); // ì´ˆ ë‹¨ìœ„
    
    if (diff < 60) return `${diff}${t('WalletMain.secondsAgo')}`;
    if (diff < 3600) return `${Math.floor(diff / 60)}${t('WalletMain.minutesAgo')}`;
    return lastUpdateTime.toLocaleTimeString('ko-KR', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  };

  const handleLock = () => {
    if (window.confirm(t('WalletMain.confirmLockWallet'))) {
      onLock();
    }
  };

  // ì§€ê°‘ ì‚­ì œ
  const handleDelete = () => {
    const confirmMessage = t('WalletMain.confirmDeleteWallets');
    
    if (window.confirm(confirmMessage)) {
      const doubleConfirm = window.prompt(t('WalletMain.confirmDeletePrompt'));
      if (doubleConfirm === 'DELETE') {
        onDelete();
      }
    }
  };

  // ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
  const checkNetworkConnection = async () => {
    try {
      const result = await walletService.testConnection();
      setNetworkStatus(result);
    } catch (error) {
      setNetworkStatus({ connected: false, error: error.message });
    }
  };

  if (currentView === 'send') {
    return (
      <div className="wallet-main">
        <div className="main-header">
          <button className="back-button" onClick={() => setCurrentView('main')}>
            â† {t('WalletMain.back')}
          </button>
          <h2>{t("wallet.send")}</h2>
        </div>
        
        <SendTransaction
          walletData={walletData}
          selectedAsset={selectedAsset}
          onSuccess={handleTransactionSuccess}
          onBack={() => setCurrentView('main')}
        />
      </div>
    );
  }

  if (currentView === 'receive') {
    return (
      <div className="wallet-main">
        <div className="main-header">
          <button className="back-button" onClick={() => setCurrentView('main')}>
            â† {t('WalletMain.back')}
          </button>
          <h2>{t("wallet.receive")}</h2>
        </div>
        
        <ReceiveWLC
          address={walletData.address}
          network={network}
          selectedAsset={selectedAsset}
        />
      </div>
    );
  }

  if (currentView === 'history') {
    return (
      <div className="wallet-main">
        <div className="main-header">
          <button className="back-button" onClick={() => setCurrentView('main')}>
            â† {t('WalletMain.back')}
          </button>
          <h2>{t("wallet.history")}</h2>
        </div>
        
        <TransactionHistory
          address={walletData.address}
          network={network}
          selectedAsset={null}
        />
      </div>
    );
  }

  if (currentView === 'settings') {
    return ( 
      <div className="wallet-main">
        <div className="main-header">
          <button className="back-button" onClick={() => setCurrentView('main')}>
            â† {t('WalletMain.back')}
          </button>
          <h2>{t('WalletMain.settings')}</h2>
        </div>
        
        <WalletSettings 
            walletData={walletData}
            onLock={handleLock}
            onDelete={handleDelete}
            onNetworkChange={checkNetworkConnection}
            onShowWalletList={onShowWalletList}
          />
      </div> 
    );
  }

  // DApp ì„œë¹„ìŠ¤ í™”ë©´
  if (showDapp) {
    if (selectedDappService === 'nft-gallery') {
      return (
        <div className="wallet-main">
          <NFTGallery 
            account={walletData.address} 
            network={network}
            onBack={handleBackFromDapp}
          /> 
        </div>
      );
    }
    
    // DApp ë©”ì¸ í™”ë©´
    return (
      <div className="wallet-main">
        <div className="main-header">
          <button className="back-button" onClick={() => setShowDapp(false)}>
            â† {t('WalletMain.back')}
          </button>
          <h2>DApp</h2>
        </div>
        <Dapp 
          onSelectService={handleDappServiceSelect}
          network={network}  // ğŸ‘ˆ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì¶”ê°€ (í•„ìš”ì‹œ)
        />
      </div>
    );
  }

  const WorldlandSVG = () => (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 557.72 69.98"
      width="180"
      height="22"
    >
      <defs>
        <style>{`
          .cls-1 { fill: #df3128; }
          .cls-2 { fill: white; }
        `}</style>
      </defs>
      <g id="Layer_2">
        <path class="cls-1" d="m49.19,48.51c-.47.27-1.05.19-1.43-.2h-.01c-.38-.4-.45-.99-.18-1.45l12.52-21.32c.27-.46.82-.68,1.34-.54,1.08.3,2.22.47,3.4.47s2.3-.17,3.37-.46c.51-.14,1.06.09,1.33.55l3.97,6.82,4.17-2.37-4-6.86c-.27-.46-.2-1.05.18-1.43,2.43-2.44,3.89-5.86,3.7-9.62-.32-6.44-5.55-11.72-11.99-12.08-7.37-.41-13.47,5.44-13.47,12.72,0,3.49,1.41,6.65,3.69,8.95.38.38.45.97.18,1.43l-12.52,21.32c-.27.46-.82.68-1.34.54-1.08-.3-2.22-.47-3.4-.47s-2.3.17-3.37.46c-.51.14-1.06-.08-1.33-.55l-12.4-21.27c-.27-.47-.2-1.06.18-1.44l.03-.03c.38-.38.97-.46,1.43-.19l23.49,13.4,2.43-4.13h0s-23.54-13.43-23.54-13.43c-.47-.27-.7-.81-.56-1.33.52-1.95.6-4.08.05-6.31C23.79,4.39,19.17.45,13.74.04,5.93-.56-.53,5.89.03,13.69c.4,5.46,4.37,10.11,9.69,11.42,2.25.55,4.41.45,6.38-.09.52-.14,1.07.08,1.34.54l12.41,21.28c.27.46.2,1.05-.18,1.43-2.43,2.44-3.89,5.86-3.7,9.62.32,6.44,5.55,11.72,11.99,12.08,7.37.41,13.47-5.44,13.47-12.72,0-1.12-.15-2.21-.43-3.24-.14-.52.09-1.06.56-1.32l11.18-6.36-4.85-2.76-8.7,4.95Z"></path><path class="cls-1" d="m115.88.04c-5.42.42-10.04,4.36-11.35,9.64-.55,2.22-.47,4.35.05,6.3.14.52-.09,1.06-.56,1.33l-37.23,21.18h0s4.85,2.76,4.85,2.76h0s34.75-19.78,34.75-19.78c.46-.26,1.05-.18,1.42.19l.02.02c.38.38.45.97.18,1.44l-12.52,21.32c-.27.46-.82.68-1.34.54-1.08-.3-2.22-.47-3.4-.47s-2.3.17-3.37.46c-.51.14-1.06-.08-1.33-.55l-3.98-6.82-4.17,2.37,4,6.86c.27.47.2,1.06-.18,1.44l-.03.03c-.38.38-.97.46-1.43.19l-23.48-13.41h0s-2.43,4.15-2.43,4.15h0s23.55,13.43,23.55,13.43c.47.27.7.81.56,1.33-.42,1.58-.55,3.28-.3,5.04.88,6.1,6.14,10.79,12.29,10.94,7.18.17,13.05-5.59,13.05-12.73,0-3.49-1.41-6.65-3.69-8.95-.38-.38-.45-.97-.18-1.43l12.52-21.32c.27-.46.82-.69,1.34-.54,1.98.56,4.14.66,6.41.11,5.33-1.3,9.3-5.96,9.7-11.43.56-7.8-5.91-14.25-13.72-13.65Z"></path></g><g><path class="cls-2" d="m236.74,6.96l-16.38,56.82h-12.83l-10.18-35.62-10.18,35.62h-12.83l-16.38-56.82h13.6l9.76,37.16,9.76-37.16h13.18l9.69,37.02,9.83-37.02h12.97Z"></path><path class="cls-2" d="m279.14,43.36c0,12.41-9.06,21.4-21.68,21.4s-21.68-8.99-21.68-21.4,9.06-21.4,21.68-21.4,21.68,8.99,21.68,21.4Zm-31.37,0c0,6.28,3.83,10.81,9.69,10.81s9.69-4.53,9.69-10.81-3.83-10.81-9.69-10.81-9.69,4.53-9.69,10.81Z"></path><path class="cls-2" d="m286.4,22.93h12.41v4.18c2.44-3.28,6.2-5.16,11.43-5.16,2.3,0,3.77.14,5.37.7l.14,11.64c-1.74-.9-3.9-1.39-6.34-1.39-6.62,0-10.6,3.77-10.6,9.97v20.91h-12.41V22.93Z"></path><path class="cls-2" d="m334.09,63.78h-12.41V5.22h12.41v58.56Z"></path><path class="cls-2" d="m341.34,43.36c0-12.41,8.16-21.4,19.87-21.4,5.37,0,9.27,1.88,11.71,5.16V5.22h12.41v58.56h-12.41v-4.18c-2.44,3.28-6.34,5.16-11.71,5.16-11.71,0-19.87-8.99-19.87-21.4Zm31.79,0c0-6.27-3.9-10.81-9.97-10.81s-9.69,4.53-9.69,10.81,3.77,10.81,9.69,10.81,9.97-4.53,9.97-10.81Z"></path><path class="cls-2" d="m407.04,63.78h-12.41V5.22h12.41v58.56Z"></path><path class="cls-2" d="m414.29,43.36c0-12.41,8.16-21.4,19.87-21.4,5.37,0,9.27,1.88,11.71,5.16v-4.18h12.41v40.85h-12.41v-4.18c-2.44,3.28-6.34,5.16-11.71,5.16-11.71,0-19.87-8.99-19.87-21.4Zm31.79,0c0-6.27-3.9-10.81-9.97-10.81s-9.69,4.53-9.69,10.81,3.76,10.81,9.69,10.81,9.97-4.53,9.97-10.81Z"></path><path class="cls-2" d="m467.64,22.93h12.41v4.18c2.44-3.28,6.21-5.16,11.43-5.16,9.48,0,15.96,6.9,15.96,18.2v23.63h-12.41v-21.54c0-6.2-2.51-9.62-7.18-9.62s-7.81,3.83-7.81,10.18v20.98h-12.41V22.93Z"></path><path class="cls-2" d="m513.73,43.36c0-12.41,8.16-21.4,19.87-21.4,5.37,0,9.27,1.88,11.71,5.16V5.22h12.41v58.56h-12.41v-4.18c-2.44,3.28-6.34,5.16-11.71,5.16-11.71,0-19.87-8.99-19.87-21.4Zm31.79,0c0-6.27-3.9-10.81-9.97-10.81s-9.69,4.53-9.69,10.81,3.77,10.81,9.69,10.81,9.97-4.53,9.97-10.81Z"></path>
      </g>
    </svg>
  );

  const getWalletButtonText = () => {
    if (walletData?.isDummy && !hasWallet) {
      return t('WalletMain.startWorldland');
    } else if (walletData?.isDummy && hasWallet) {
      return t('WalletMain.openWallet');
    } else {
      return t('WalletMain.settings'); // ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìŒ
    }
  };

  const displayStatus = () => {
    if (walletData?.isDummy && !hasWallet) {
      return t('WalletMain.welcomeMessage');
    } else if (walletData?.isDummy && hasWallet) {
      return t('WalletMain.openWalletMessage');
    } else {
      return t('WalletMain.settings');
    }
  };



  // const handleResetWallet = async () => {
  //   const confirmMessage = t('WalletMain.resetConfirmMessage');

  //   if (window.confirm(confirmMessage)) {
  //     const doubleConfirm = window.prompt(t('WalletMain.resetDoubleConfirm'));
      
  //     if (doubleConfirm === 'RESET ALL') {
  //       try {
  //         console.log('ğŸ—‘ï¸ ì „ì²´ ë°ì´í„° ë¦¬ì…‹ ì‹œì‘...');
          
  //         // 1. ëª¨ë“  ì§€ê°‘ ë°ì´í„° ì‚­ì œ
  //         await MultiWalletManager.clearAllWallets();
          
  //         // 2. SecureStorage ëª¨ë“  ë°ì´í„° ì‚­ì œ
  //         SecureStorage.removeWallet();
  //         SecureStorage.secureDeleteTokens();
  //         SecureStorage.clearAllSessionData();
          
  //         // 3. localStorage ì™„ì „ ì •ë¦¬
  //         const keysToRemove = [];
  //         for (let i = 0; i < localStorage.length; i++) {
  //           const key = localStorage.key(i);
  //           if (key && key.startsWith('worldland_')) {
  //             keysToRemove.push(key);
  //           }
  //         }
  //         keysToRemove.forEach(key => localStorage.removeItem(key));
          
  //         // 4. sessionStorageë„ ì •ë¦¬
  //         sessionStorage.clear();
          
  //         console.log('âœ… ì „ì²´ ë°ì´í„° ë¦¬ì…‹ ì™„ë£Œ');
          
  //         // 5. ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
  //         alert(t('WalletMain.resetSuccessMessage'));
  //         window.location.reload();
          
  //       } catch (error) {
  //         console.error('âŒ ë°ì´í„° ë¦¬ì…‹ ì‹¤íŒ¨:', error);
  //         setError(t('WalletMain.resetErrorMessage') + error.message);
  //       }
  //     } else {
  //       alert(t('WalletMain.resetInputMismatch'));
  //     }
  //   }
  // };

  return (
    <div className="wallet-main" >
      {/* ë©”ì‹œì§€ */}
      {error && (
        <div className="message error">
          {error}
          <button onClick={() => setError('')}>Ã—</button>
        </div>
      )}
      {success && (
        <div className="message success">
          {success}
        </div>
      )}

      {/* í—¤ë” */}
      <div className="wallet-header">
        <div className="logo-link">
          <a href="https://worldland.foundation" target="_blank" rel="noopener noreferrer">
            <WorldlandSVG />
          </a>
        </div>

        <div className="header-actions">  
          <button 
            className="action-btn"
            onClick={onShowWalletList}
            title={t("wallet.selectWallet")}
          >
            <Wallet size={16} /> 
          </button> 

          <button 
            className="action-btn"
            onClick={() => setCurrentView('settings')}
            title={t("wallet.settings")}
          > 
            <Settings size={16} /> 
          </button>

          <button 
            className="action-btn"
            onClick={onLock}
            title={t("wallet.lockWallet")}
          >
            <Lock size={16} />
          </button> 
        </div>
      </div>
 
      <div className="wallet-info-main" style={{display: 'flex', justifyContent: 'space-between'}}> 
      {walletData?.isDummy ? (
        // ë”ë¯¸ ë°ì´í„°ì¼ ë•Œ: ì§€ê°‘ ì„¤ì • ë²„íŠ¼ í‘œì‹œ
        <>
          <Wallet /> 
          <div className="wallet-name"> 
            <h3>{t('WalletMain.noWallet')}</h3>
          </div>
          <button 
            className="setup-wallet-btn"
            onClick={onShowWalletSetup}
          >
            {getWalletButtonText()}
          </button>
        </>
      ) : (
        // ì‹¤ì œ ì§€ê°‘ ë°ì´í„°ì¼ ë•Œ: ê¸°ì¡´ UI
        <>
          <h3><Wallet /> </h3>
          <div>
          <div className="wallet-name"> 
            <h3>"{walletData.alias}"</h3>
          </div>
          <div className="wallet-address" onClick={() => copyToClipboard(walletData.address)}>
            {formatAddress(walletData.address)}
            <Copy size={16} />
          </div>
          </div>
          
          <button 
            className={`action-btn refresh-btn ${isLoading || isAutoRefreshing ? 'loading' : ''}`}
            onClick={handleManualRefresh}
            disabled={isLoading}
            title={isAutoRefreshing ? t('WalletMain.autoUpdating') : t('WalletMain.refreshBalance')}
          >
            <RefreshCw size={16} className={(isLoading || isAutoRefreshing) ? 'spin' : ''} />
          </button>
        </>
      )}

      {/* <LanguageToggle /> */}

        {/* ìƒˆë¡œ ì¶”ê°€ë˜ëŠ” reset ë²„íŠ¼ */}
        {/* <div className="reset-wallet-container">
          <button 
            className="reset-wallet-btn"
            onClick={handleResetWallet}
            title={t('WalletMain.resetWalletTooltip')}
          >
            {t('WalletMain.resetWallet')}
          </button>
        </div> */}
        <div className="dapp-button-container">
          <button 
            className="dapp-button"
            onClick={handleDappButtonClick}  // ğŸ‘ˆ ìˆ˜ì •ë¨
            title={t('WalletMain.openDapp')}
          >
            {t('WalletMain.Dapp')}
          </button>
        </div>
    </div>

    

      {/* ìì‚° ì„ íƒê¸° */}
    {!walletData?.isDummy ? (
      <div className="asset-selector">
        <button 
          className="selected-asset"
          onClick={() => setShowTokenList(!showTokenList)}
        >
          <div className="asset-info">
            <div className="asset-icon">
              {selectedAsset?.type === 'native' ? 'ğŸ†' : 'ğŸª™'}
            </div>
            <div className="asset-details">
              <div className="asset-symbol">{selectedAsset?.symbol || 'WLC'}</div>
              <div className="asset-name">{selectedAsset?.name || 'WorldLand Coin'}</div>
            </div>
          </div>
          <div className="asset-balance">
            <div className="balance-amount">
              {formatBalance(selectedAsset?.balance || balance)}
            </div>
            <div className="balance-currency">{selectedAsset?.symbol || 'WLC'}</div>
          </div>
          {showTokenList ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
        </button>

        

        {/* ìë™ ì—…ë°ì´íŠ¸ ìƒíƒœ í‘œì‹œ */}
        {(lastUpdateTime || isAutoRefreshing) && (
          <div className="auto-refresh-status">
            <div className="status-indicator">
              {isAutoRefreshing ? (
                <>
                  <RefreshCw size={12} className="spin" />
                  <span>{t('WalletMain.updating')}</span>
                </>
              ) : (
                <>
                </>
              )}
            </div>
            <div className="next-update">
              {!isAutoRefreshing && t('WalletMain.autoRefreshInterval')}
            </div>
          </div> 
        )}

        

        {showTokenList && (
          <div className="asset-dropdown">
            <div className="dropdown-header">
              <div className="search-box">
                <Search size={16} />
                <input
                  type="text"
                  placeholder={t('WalletMain.searchTokens')}
                  value={searchToken}
                  onChange={(e) => setSearchToken(e.target.value)}
                />
              </div>
              <div className="header-buttons">
                <button 
                  className="browse-tokens-btn"
                  onClick={() => setShowTokenBrowser(true)}
                  title={t('WalletMain.browseTokens')}
                >
                  <Coins size={16} />
                </button>
                <button 
                  className="add-token-btn"
                  onClick={() => setShowAddToken(true)}
                  title={t('WalletMain.addByAddress')}
                >
                  <Plus size={16} />
                </button>
                <button 
                  className="browse-tokens-btn"
                  onClick={handleManualTokenDiscovery}
                  disabled={isLoading}
                  title={t('WalletMain.autoDiscoverTokens')}
                >
                  <Search size={16} />
                </button>
              </div>
            </div>

            <div className="asset-list">
              {filteredAssets.map((asset, index) => (
                <div 
                  key={asset.address || 'native'}
                  className={`asset-item ${selectedAsset?.address === asset.address || 
                    (selectedAsset?.type === 'native' && asset.type === 'native') ? 'active' : ''}`}
                  onClick={() => handleAssetSelect(asset)}
                >
                  <div className="asset-info" >
                    <div className="asset-icon" onClick={(e) => {
                              e.stopPropagation();
                              handleViewTokenDetail(asset);
                            }}
                            title={t('WalletMain.tokenDetailInfo')}>
                      {asset.type === 'native' ? 'ğŸ†' : 'ğŸª™'}
                    </div>
                    

                    <div className="asset-details">
                      <div className="asset-symbol"   
                            title={t('WalletMain.tokenSelection')}>  
                            {asset.symbol} 
                      </div>
                      <div className="asset-name">{asset.name}</div>
                      
                    </div>
                  </div>
                  <div className="asset-balance">
                    <div className="balance-amount">
                      {formatBalance(asset.balance)}
                    </div>
                    <div className="asset-actions">
                      {asset.type !== 'native' && (
                        <>
                          <button 
                            className="view-token-btn"
                            onClick={(e) => {
                              e.stopPropagation();
                              handleViewTokenDetail(asset);
                            }}
                            title={t('WalletMain.tokenDetailInfo')}
                          >
                            <Eye size={12} />
                          </button>
                          <button 
                            className="remove-token-btn"
                            onClick={(e) => {
                              e.stopPropagation();
                              handleRemoveToken(asset.address);
                            }}
                            title={t('WalletMain.removeToken')}
                          >
                            <X size={12} />
                          </button>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              ))}
              
              {filteredAssets.length === 0 && (
                <div className="no-assets">
                  {t('WalletMain.noSearchResults')}
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    ):(
      <div className="asset-selector" style={{display: 'flex', flexDirection: 'row'}}>
        <button 
          className="selected-asset" 
          style={{display: 'flex', alignItems: 'center', justifyContent: 'center'}}
        >
          <div className="asset-icon">
            {selectedAsset?.type === 'native' ? 'ğŸ†' : 'ğŸª™'}
          </div>
          <div className='password_required' style={{width: '100%', padding: '0px 50px'}}> 
            <label>
            {displayStatus()} 
            </label>
          </div> 
        </button>
      </div>

    )}

      {/* í† í° ë¸Œë¼ìš°ì € ëª¨ë‹¬ */}
      {showTokenBrowser && (
        <div className="modal-overlay">
          <div className="modal-content token-browser-modal">
            <div className="modal-header">
              <h3>{t('WalletMain.browseTokens')}</h3>
              <button onClick={() => setShowTokenBrowser(false)}>Ã—</button>
            </div>

            <div className="modal-body">
              <div className="browser-search">
                <div className="search-box">
                  <Search size={16} />
                  <input
                    type="text"
                    placeholder={t('WalletMain.searchByNameOrSymbol')}
                    value={searchToken}
                    onChange={(e) => {
                      setSearchToken(e.target.value);
                      handleTokenSearch(e.target.value);
                    }}
                  />
                </div>
                {isSearching && (
                  <div className="searching-indicator">
                    <RefreshCw className="spin" size={16} />
                    {t('WalletMain.searching')}
                  </div>
                )}
              </div>

              <div className="token-sections">
                {searchToken.trim() ? (
                  // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
                  <div className="token-section">
                    <h4>{t('WalletMain.searchResults')} ({searchResults.length})</h4>
                    <div className="token-browser-list">
                      {searchResults.length === 0 && !isSearching ? (
                        <div className="no-results">
                          {t('WalletMain.noSearchResults')}
                        </div>
                      ) : (
                        searchResults.map((token) => (
                          <TokenBrowserItem
                            key={token.address}
                            token={token}
                            onAdd={() => handleAddToken(token)}
                            isAdded={tokens.some(t => t.address.toLowerCase() === token.address.toLowerCase())}
                          />
                        ))
                      )}
                    </div>
                  </div>
                ) : (
                  // ì¸ê¸° í† í° ëª©ë¡ í‘œì‹œ
                  <div className="token-section">
                    <h4>{t('WalletMain.popularTokens')} ({popularTokens.length})</h4>
                    <div className="token-browser-list">
                      {popularTokens.length === 0 ? (
                        <div className="loading-tokens">
                          <RefreshCw className="spin" size={16} />
                          {t('WalletMain.loadingTokenList')}
                        </div>
                      ) : (
                        popularTokens.map((token) => (
                          <TokenBrowserItem
                            key={token.address}
                            token={token}
                            onAdd={() => handleAddToken(token)}
                            isAdded={tokens.some(t => t.address.toLowerCase() === token.address.toLowerCase())}
                          />
                        ))
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>

            <div className="modal-actions">
              <button 
                className="cancel-btn" 
                onClick={() => setShowTokenBrowser(false)}
              >
                {t('WalletMain.close')}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* í† í° ì¶”ê°€ ëª¨ë‹¬ */}
      {showAddToken && (
        <div className="modal-overlay">
          <div className="modal-content add-token-modal">
            <div className="modal-header">
              <h3>{t('WalletMain.addToken')}</h3>
              <button onClick={() => setShowAddToken(false)}>Ã—</button>
            </div>

            <div className="modal-body">
              <div className="form-group">
                <label>{t('WalletMain.tokenContractAddress')}</label>
                <input
                  type="text"
                  value={newTokenAddress}
                  onChange={(e) => setNewTokenAddress(e.target.value)}
                  placeholder={t('WalletMain.contractAddress')}
                />
              </div>
              
              <div className="token-info">
                <p>{t('WalletMain.tokenAutoAddInfo')}</p>
                <p>{t('WalletMain.trustWarning')}</p>
              </div>
            </div>

            <div className="modal-actions">
              <button 
                className="primary-btn"
                onClick={() => handleAddToken()}
                disabled={isLoading || !newTokenAddress.trim()}
              >
                {isLoading ? t('WalletMain.adding') : t('WalletMain.addToken')}
              </button>
              <button 
                className="cancel-btn" 
                onClick={() => setShowAddToken(false)}
              >
                {t('WalletMain.cancel')}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ì”ì•¡ ì¹´ë“œ */}
      <div className="balance-card">
        <div className="balance-actions">
          <button 
            className="balance-action-btn send-btn"
            onClick={() => setCurrentView('send')}
          >
            <Send size={20} />
            <span>{t("wallet.send")}</span>
          </button>
          
          <button 
            className="balance-action-btn receive-btn"
            onClick={() => setCurrentView('receive')}
          >
            <ArrowDownToLine size={20} />
            <span> {t("wallet.receive")} </span>
          </button>
          
          <button 
            className="balance-action-btn history-btn"
            onClick={() => setCurrentView('history')}
          >
            <History size={20} />
            <span>{t("wallet.history")}</span>
          </button>
        </div>
      </div>

      {/* ë„¤íŠ¸ì›Œí¬ ì •ë³´ */}
      <div className="network-info">
        <div className="network-item" >
          <span className="label">{t('WalletMain.network')}:</span>
          <span className="value">{network.name}</span>
        </div>
        <div className="network-item">
          <span className="label">{t('WalletMain.chainId')}:</span>
          <span className="value">{network.chainId}</span>
        </div>
      </div>

      {bannerAds && (
        <div className="banner-ads-container">
          <img 
            src={bannerAds.imageSrc || '/bannerAds.png'} 
            alt={bannerAds.altText || t('WalletMain.sponsorAdBanner')} 
            className="banner-ads-image" 
            onClick={handleBannerClick}
            style={{ cursor: bannerAds.url ? 'pointer' : 'default' }}
          />
        </div>
      )}

      {isLoadingBanner && (
        <div className="banner-ads-container">
          <div className="banner-ads-loading">
            <div className="loading-placeholder">{t('WalletMain.adLoading')}</div>
          </div>
        </div>
      )}

      {/* ê²Œì‹œíŒ */}
      {infoUrls.length > 0 && (
        <div className="info-board-container">
          <h4>{t('WalletMain.bulletinBoard')}</h4>
          <div className="board-posts-grid">
            {(showAllUrls ? infoUrls : infoUrls.slice(0, 4)).map((item) => (
              <div 
                key={item.id} 
                className="board-post-item"
                onClick={() => window.open(item.url, '_blank', 'noopener,noreferrer')}
              >
                <div className="post-content">
                  <div className="post-title">{item.title}</div>
                  <div className="post-description">{item.description}</div>
                </div>
                <div className="post-metadata">
                  {item.category && <span className="post-category">{item.category}</span>}
                  {item.date && <span className="post-date">{item.date}</span>}
                </div>
              </div>
            ))}
          </div>
          {infoUrls.length > 4 && (
            <div className="board-more-section">
              <button 
                className="board-toggle-btn"
                onClick={() => setShowAllUrls(!showAllUrls)}
              >
                {showAllUrls 
                  ? t('WalletMain.fold')
                  : `+${infoUrls.length - 4}${t('WalletMain.showMoreItems')}`
                }
              </button>
            </div>
          )}
        </div>
      )}

      {/* í† í° ìƒì„¸ ì •ë³´ ëª¨ë‹¬ */}
      {showTokenDetail && selectedTokenDetail && (
        <div className="modal-overlay">
          <div className="modal-content token-detail-modal">
            <div className="modal-header">
              <h3>{selectedTokenDetail.symbol} {t('WalletMain.tokenDetail')}</h3>
              <button onClick={handleCloseTokenDetail}>Ã—</button>
            </div>

            <div className="modal-body">
              <div className="token-detail-info">
                <div className="detail-row">
                  <span className="label">{t('WalletMain.tokenName')}:</span>
                  <span className="value">{selectedTokenDetail.name}</span>
                </div>
                <div className="detail-row">
                  <span className="label">{t('WalletMain.symbol')}:</span>
                  <span className="value">{selectedTokenDetail.symbol}</span>
                </div>
                <div className="detail-row">
                  <span className="label">{t('WalletMain.tokenContractAddress')}:</span>
                  <span className="value address-value">
                    {selectedTokenDetail.address}
                    <button 
                      onClick={() => copyToClipboard(selectedTokenDetail.address, t('WalletMain.tokenAddressCopied'))}
                      className="copy-btn"
                    >
                      <Copy size={12} />
                    </button>
                  </span>
                </div>
                <div className="detail-row">
                  <span className="label">{t('WalletMain.decimals')}:</span>
                  <span className="value">{selectedTokenDetail.decimals}</span>
                </div>
                <div className="detail-row">
                  <span className="label">{t('WalletMain.balance')}:</span>
                  <span className="value">{formatBalance(selectedTokenDetail.balance)} {selectedTokenDetail.symbol}</span>
                </div>
                {selectedTokenDetail.verified && (
                  <div className="detail-row">
                    <span className="label">{t('WalletMain.verificationStatus')}:</span>
                    <span className="value verified">âœ“ {t('WalletMain.verified')}</span>
                  </div>
                )}
              </div>

              <div className="external-links">
                <h4>{t('WalletMain.externalLinks')}</h4>
                <div className="link-buttons">
                  {selectedTokenDetail.homepage && (
                    <button 
                      className="external-link-btn homepage-btn"
                      onClick={() => window.open(selectedTokenDetail.homepage, '_blank', 'noopener,noreferrer')}
                      title={t('WalletMain.officialHomepage')}
                    >
                      ğŸ  {t('WalletMain.officialHomepage')}
                    </button>
                  )}
                  <button 
                    className="external-link-btn"
                    onClick={() => window.open(`https://scan.worldland.foundation/token/${selectedTokenDetail.address}`, '_blank')}
                  >
                    ğŸ“Š {t('WalletMain.tokenInfoView')}
                  </button>
                  <button 
                    className="external-link-btn"
                    onClick={() => window.open(`https://scan.worldland.foundation/token/${selectedTokenDetail.address}/token-transfers`, '_blank')}
                  >
                    ğŸ“ˆ {t('WalletMain.tokenTransferHistory')}
                  </button>
                  <button 
                    className="external-link-btn"
                    onClick={() => window.open(`https://scan.worldland.foundation/address/${walletData.address}/tokens`, '_blank')}
                  >
                    ğŸ’¼ {t('WalletMain.allWalletTokens')}
                  </button>
                </div>
              </div>
            </div>

            <div className="modal-actions">
              <button 
                className="cancel-btn" 
                onClick={handleCloseTokenDetail}
              >
                {t('WalletMain.close')}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// í† í° ë¸Œë¼ìš°ì € ì•„ì´í…œ ì»´í¬ë„ŒíŠ¸
const TokenBrowserItem = ({ token, onAdd, isAdded }) => {
 const { t } = useTranslation();
 
 const formatNumber = (num) => {
   if (num < 1000) return num.toString();
   if (num < 1000000) return (num / 1000).toFixed(1) + 'K';
   if (num < 1000000000) return (num / 1000000).toFixed(1) + 'M';
   return (num / 1000000000).toFixed(1) + 'B';
 };

 return (
   <div className="token-browser-item">
     <div className="token-main-info">
       <div className="token-icon">
         ğŸª™
       </div>
       <div className="token-details">
         <div className="token-name-row">
           <span className="token-name">{token.name}</span>
           {token.verified && <span className="verified-badge">âœ“</span>}
         </div>
         <div className="token-symbol">{token.symbol}</div>
         <div className="token-address">{token.address.slice(0, 10)}...{token.address.slice(-8)}</div>
       </div>
     </div>
     
     <div className="token-stats">
       <div className="stat-item">
         <span className="stat-label">{t('WalletMain.holders')}</span>
         <span className="stat-value">{formatNumber(token.holderCount || 0)}</span>
       </div>
       {token.description && (
         <div className="token-description">
           {token.description.slice(0, 50)}...
         </div>
       )}
     </div>

     <div className="token-actions">
       <button 
         className={`add-token-btn ${isAdded ? 'added' : ''}`}
         onClick={onAdd}
         disabled={isAdded}
       >
         {isAdded ? (
           <>
             <CheckCircle size={16} />
             {t('WalletMain.added')}
           </>
         ) : (
           <>
             <Plus size={16} />
             {t('WalletMain.add')}
           </>
         )}
       </button>
     </div>
   </div>
 );
};

export default WalletMain;